

### Проведение нагрузочное тестирования и профилирования PUT-запросов.
Для формирования запроса использовался скрипт put.lua:
```
counter = 0

request = function()
    path = "/v0/entity?id=key" .. counter
    wrk.method = "PUT"
    wrk.body = "value" .. counter
    counter = counter + 1
    return wrk.format(nil, path)
end
```
Нагрузочное тестирование запускалось командой:
```
wrk2 -c 1 -t 1 -d 2m -R 10000 -L -s wrk/put.lua http://localhost:8080
```
Был получен результат:
```
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   293.36ms  597.21ms   2.44s    84.38%
    Req/Sec    10.66k     6.11k   28.67k    75.02%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.04ms
 75.000%   82.24ms
 90.000%    1.39s 
 99.000%    2.20s 
 99.900%    2.40s 
 99.990%    2.44s 
 99.999%    2.45s 
100.000%    2.45s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.036     0.000000            2         1.00
       0.271     0.100000       109539         1.11
       0.481     0.200000       218795         1.25
       0.677     0.300000       327981         1.43
       0.865     0.400000       437575         1.67
       1.044     0.500000       546682         2.00
       1.129     0.550000       601374         2.22
       1.216     0.600000       655901         2.50
       1.306     0.650000       710433         2.86
       1.723     0.700000       764812         3.33
      82.239     0.750000       819394         4.00
     302.079     0.775000       846721         4.44
     509.695     0.800000       874029         5.00
     724.479     0.825000       901330         5.71
     945.151     0.850000       928706         6.67
    1165.311     0.875000       956026         8.00
    1274.879     0.887500       969689         8.89
    1385.471     0.900000       983357        10.00
    1492.991     0.912500       996931        11.43
    1601.535     0.925000      1010677        13.33
    1711.103     0.937500      1024347        16.00
    1767.423     0.943750      1031093        17.78
    1821.695     0.950000      1037950        20.00
    1875.967     0.956250      1044721        22.86
    1931.263     0.962500      1051615        26.67
    1985.535     0.968750      1058451        32.00
    2012.159     0.971875      1061856        35.56
    2039.807     0.975000      1065324        40.00
    2064.383     0.978125      1068632        45.71
    2092.031     0.981250      1072094        53.33
    2121.727     0.984375      1075614        64.00
    2140.159     0.985938      1077301        71.11
    2158.591     0.987500      1078898        80.00
    2183.167     0.989062      1080703        91.43
    2205.695     0.990625      1082395       106.67
    2228.223     0.992188      1084118       128.00
    2238.463     0.992969      1084854       142.22
    2254.847     0.993750      1085747       160.00
    2273.279     0.994531      1086602       182.86
    2295.807     0.995313      1087447       213.33
    2318.335     0.996094      1088277       256.00
    2330.623     0.996484      1088736       284.44
    2340.863     0.996875      1089109       320.00
    2353.151     0.997266      1089590       365.71
    2363.391     0.997656      1089998       426.67
    2373.631     0.998047      1090422       512.00
    2379.775     0.998242      1090657       568.89
    2383.871     0.998437      1090814       640.00
    2390.015     0.998633      1091060       731.43
    2394.111     0.998828      1091246       853.33
    2400.255     0.999023      1091522      1024.00
    2402.303     0.999121      1091565      1137.78
    2408.447     0.999219      1091693      1280.00
    2412.543     0.999316      1091774      1462.86
    2418.687     0.999414      1091903      1706.67
    2422.783     0.999512      1091994      2048.00
    2426.879     0.999561      1092074      2275.56
    2428.927     0.999609      1092125      2560.00
    2430.975     0.999658      1092167      2925.71
    2433.023     0.999707      1092212      3413.33
    2435.071     0.999756      1092269      4096.00
    2437.119     0.999780      1092316      4551.11
    2437.119     0.999805      1092316      5120.00
    2439.167     0.999829      1092362      5851.43
    2439.167     0.999854      1092362      6826.67
    2441.215     0.999878      1092425      8192.00
    2441.215     0.999890      1092425      9102.22
    2441.215     0.999902      1092425     10240.00
    2441.215     0.999915      1092425     11702.86
    2443.263     0.999927      1092491     13653.33
    2443.263     0.999939      1092491     16384.00
    2443.263     0.999945      1092491     18204.44
    2443.263     0.999951      1092491     20480.00
    2443.263     0.999957      1092491     23405.71
    2443.263     0.999963      1092491     27306.67
    2443.263     0.999969      1092491     32768.00
    2443.263     0.999973      1092491     36408.89
    2443.263     0.999976      1092491     40960.00
    2443.263     0.999979      1092491     46811.43
    2445.311     0.999982      1092514     54613.33
    2445.311     1.000000      1092514          inf
#[Mean    =      293.362, StdDeviation   =      597.212]
#[Max     =     2443.264, Total count    =      1092514]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1192551 requests in 2.00m, 76.20MB read
  Socket errors: connect 0, read 0, write 0, timeout 1
Requests/sec:   9936.11
Transfer/sec:    650.12KB
```
Профилироване CPU запускалось командой:
```
./profiler.sh -d 30 -f put_cpu.html 29891
```
[Результат профилирования CPU](put_cpu.png)

Профилирование alloc запускалось командой:
```
./profiler.sh -d 30 -e alloc -f put_mem.html 29891
```
[Результат профилирования alloc](put_mem.png)

По результатам сестирования видно что около 75% запросов обрабатываются почти без задержек.
Однако для более чем 10% запросов задержка превышала секунду.
По результатам профилирования CPU видно, что основная задержка появляется при методе `flush`. Это можно испарвить сделав выгрузку данных на диск в фоне.

Также по результатам профилирования alloc заметно,что заметная часть памяти уходит при постоянном копировании `ByteBuffer`.
Однако это вынужденные меры для обеспечения целостности данных.


### Проведение нагрузочное тестирования и профилирования GET-запросов.
Для формирования запроса использовался скрипт put.lua:
```
counter = 0

request = function()
    path = "/v0/entity?id=key" .. counter
    wrk.method = "GET"
    wrk.body = "value" .. counter
    counter = counter + 1
    return wrk.format(nil, path)
end
```
Нагрузочное тестирование запускалось командой:
```
wrk2 -c 1 -t 1 -d 2m -R 10000 -L -s wrk/get.lua http://localhost:8080
```
Был получен результат:
```
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   228.40ms  519.13ms   2.47s    85.54%
    Req/Sec    10.59k     2.97k   24.56k    82.53%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.01ms
 75.000%   43.52ms
 90.000%  992.77ms
 99.000%    2.38s 
 99.900%    2.47s 
 99.990%    2.47s 
 99.999%    2.47s 
100.000%    2.47s 

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.042     0.000000            1         1.00
       0.257     0.100000       110166         1.11
       0.452     0.200000       220278         1.25
       0.644     0.300000       330164         1.43
       0.830     0.400000       440169         1.67
       1.010     0.500000       550294         2.00
       1.096     0.550000       605074         2.22
       1.186     0.600000       660405         2.50
       1.285     0.650000       715217         2.86
       1.824     0.700000       769974         3.33
      43.519     0.750000       824969         4.00
     101.311     0.775000       852482         4.44
     179.711     0.800000       879970         5.00
     371.711     0.825000       907493         5.71
     716.287     0.850000       935033         6.67
     871.935     0.875000       962473         8.00
     942.591     0.887500       976306         8.89
     992.767     0.900000       990035        10.00
    1104.895     0.912500      1003882        11.43
    1190.911     0.925000      1017584        13.33
    1266.687     0.937500      1031321        16.00
    1291.263     0.943750      1038426        17.78
    1350.655     0.950000      1045007        20.00
    1436.671     0.956250      1051940        22.86
    1614.847     0.962500      1058726        26.67
    1888.255     0.968750      1065583        32.00
    1969.151     0.971875      1069041        35.56
    2049.023     0.975000      1072476        40.00
    2162.687     0.978125      1075941        45.71
    2193.407     0.981250      1079338        53.33
    2240.511     0.984375      1082823        64.00
    2303.999     0.985938      1084540        71.11
    2332.671     0.987500      1086238        80.00
    2365.439     0.989062      1087946        91.43
    2390.015     0.990625      1089661       106.67
    2412.543     0.992188      1091648       128.00
    2416.639     0.992969      1092625       142.22
    2418.687     0.993750      1093098       160.00
    2424.831     0.994531      1093949       182.86
    2433.023     0.995313      1095191       213.33
    2443.263     0.996094      1095805       256.00
    2445.311     0.996484      1096099       284.44
    2449.407     0.996875      1096581       320.00
    2453.503     0.997266      1097245       365.71
    2455.551     0.997656      1097586       426.67
    2459.647     0.998047      1097835       512.00
    2463.743     0.998242      1098161       568.89
    2465.791     0.998437      1098302       640.00
    2467.839     0.998633      1098566       731.43
    2469.887     0.998828      1099417       853.33
    2469.887     0.999023      1099417      1024.00
    2469.887     0.999121      1099417      1137.78
    2469.887     0.999219      1099417      1280.00
    2469.887     0.999316      1099417      1462.86
    2469.887     0.999414      1099417      1706.67
    2471.935     0.999512      1099955      2048.00
    2471.935     1.000000      1099955          inf
#[Mean    =      228.403, StdDeviation   =      519.127]
#[Max     =     2469.888, Total count    =      1099955]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  1199989 requests in 2.00m, 84.72MB read
  Non-2xx or 3xx responses: 7437
Requests/sec:   9999.93
Transfer/sec:    722.93KB

```
Профилироване CPU запускалось командой:
```
./profiler.sh -d 30 -f get_cpu.html 29891
```
[Результат профилирования CPU](get_cpu.png)

Профилирование alloc запускалось командой:
```
./profiler.sh -d 30 -e alloc -f get_mem.html 29891
```
[Результат профилирования alloc](get_mem.png)

По результатам сестирования видно что около 75% запросов обрабатываются почти без задержек. 
При этом у около 10% запросов задержка превышала секунду.
По результатам профилирования CPU видно, что больше всего времени уходит на `sstableRanges`, т.к. происходит чтение с диска.
По профилированю alloc заметно что больше всего памяти используется на итераторы.


